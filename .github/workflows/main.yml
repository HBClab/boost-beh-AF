name: Task1 QC
on: [push]

jobs:
  process_raw:
    runs-on: self-hosted
    steps:
      - name: checkout code and return recently uploaded file in data
        uses: actions/checkout@v2
      - name: get most recent file
        run: |
          git config pull.rebase false
          git pull origin main
          data=$(ls -t /data/*.txt | head -n 1)
          echo "Most recent file: $data"

      - name: set up python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: parse raw
        run: |
          // add bash to parse raw data filename, split by '_', and save as local variable
          #!/bin/bash
          filename=$(basename $data)
          IFS='_' read -r sub task version <<< "$filename"
          echo "sub=$sub" >> $GITHUB_ENV
          echo "task=$task" >> $GITHUB_ENV
          echo "version=$version" >> $GITHUB_ENV
          echo "Subject: $sub"
          echo "Task: $task"
          echo "Version: $version"

      - name: convert raw
        run: |
          mkdir data/${sub}/processed
          python code/ConvertBeh.py -submission ${data} -out data/${sub}/processed -sub ${sub} -task ${task} -taskvers ${version}

  run_qc:
    runs-on: self-hosted
    needs: process_raw
    steps:
      - name: run quality control
        run: python AFqC.py -s data/${sub}/processed/${sub}*.csv -o data/${sub}/ -sub ${sub} | tee data/${sub}/qc.log

  push:
    runs-on: self-hosted
    needs: run_qc
    steps:
      - name: push results
        run: |
          git config user.email zjgilliam@uiowa.edu
          git config user.name "Zak Gilliam"
          git add -A
          git commit -m "QC results for ${sub}"
          git push origin main
